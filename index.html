<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>ARea Light Editor – Pipeline-Test</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      background: radial-gradient(circle at top, #1f2937, #020617);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #e5e7eb;
    }
    .shell {
      width: 100%;
      max-width: 720px;
      padding: 20px 16px 24px;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 20px;
    }
    small {
      color: #9ca3af;
      line-height: 1.4;
    }
    form {
      margin-top: 16px;
      padding: 16px;
      border-radius: 16px;
      background: rgba(15,23,42,0.88);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 18px 40px rgba(15,23,42,0.8);
    }
    label {
      display: block;
      margin-top: 10px;
      font-size: 13px;
      color: #d1d5db;
    }
    input[type="file"],
    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      margin-top: 4px;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.4);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      font-size: 13px;
    }
    input::placeholder {
      color: #6b7280;
    }
    select {
      cursor: pointer;
    }
    button {
      margin-top: 14px;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(135deg,#4f46e5,#22d3ee);
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button[disabled] {
      opacity: 0.5;
      cursor: default;
    }
    #status {
      margin-top: 14px;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 260px;
      overflow: auto;
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      padding: 8px;
      border: 1px solid rgba(55,65,81,0.9);
    }
    a {
      color: #7dd3fc;
      word-break: break-all;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(15,23,42,0.9);
      padding: 2px 4px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <h1>ARea Light Editor</h1>
    <small>
      Minimal-Tool zum Testen der Pipeline:<br>
      <strong>GLB → /publish → Surface Viewer</strong><br>
      (ohne Three.js, ohne Viewport – nur Datenfluss).
    </small>

    <form id="form">
      <label>
        GLB mit Animation
        <input id="fileGlb" type="file" accept=".glb,model/gltf-binary" />
      </label>

      <label>
        Animations-Clip-Name
        <input id="clipName" type="text" placeholder="z.B. Walk, Idle oder * für ersten Clip" />
      </label>

      <label>
        Startmodus
        <select id="startMode">
          <option value="onPlace">onPlace – Start nach Placement in AR</option>
          <option value="onStart">onStart – direkt beim Laden</option>
          <option value="onClick">onClick – bei Tap/Click</option>
          <option value="manual">manual – nur über Buttons</option>
        </select>
      </label>

      <label>
        Szene-ID (optional, sonst wird eine generiert)
        <input id="sceneId" type="text" placeholder="z.B. testcube-01" />
      </label>

      <label>
        X-AREA-Key (aus Cloudflare Worker, bleibt nur im Browser)
        <input id="publishKey" type="password" placeholder="geheimer Key aus area-publish Worker" />
      </label>

      <button id="btnPublish" type="button" disabled>⬆ Publish nach Cloudflare</button>

      <div id="status"></div>
    </form>
  </div>

<script>
  // --- Konfiguration --------------------------------------------------------
  const PUBLISH_URL = 'https://area-publish.area-webar.workers.dev/publish';
  const VIEWER_BASE = 'https://area-viewer.pages.dev/surface-ar/area-viewer.html';
  const workerOrigin = new URL(PUBLISH_URL).origin;
  const KEY_STORAGE = 'area_lighteditor_publish_key';

  const fileInput   = document.getElementById('fileGlb');
  const clipInput   = document.getElementById('clipName');
  const startSelect = document.getElementById('startMode');
  const sceneInput  = document.getElementById('sceneId');
  const keyInput    = document.getElementById('publishKey');
  const btnPublish  = document.getElementById('btnPublish');
  const statusEl    = document.getElementById('status');

  let glbFile = null;

  function log(msg){
    console.log(msg);
    statusEl.textContent += (statusEl.textContent ? '\n' : '') + msg;
    statusEl.scrollTop = statusEl.scrollHeight;
  }

  // Key aus localStorage vorbefüllen (nur Browser-seitig)
  const savedKey = localStorage.getItem(KEY_STORAGE);
  if (savedKey) {
    keyInput.value = savedKey;
  }

  // --- GLB-Auswahl ----------------------------------------------------------
  fileInput.addEventListener('change', () => {
    const file = fileInput.files && fileInput.files[0];
    statusEl.textContent = '';
    glbFile = null;

    if (!file) {
      log('Bitte eine GLB-Datei auswählen.');
      btnPublish.disabled = true;
      return;
    }
    if (!file.name.toLowerCase().endsWith('.glb')) {
      log('⚠ Gewählte Datei ist kein .glb – bitte ein GLB mit Animation wählen.');
      btnPublish.disabled = true;
      return;
    }

    glbFile = file;
    log(`GLB gewählt: ${file.name} (${file.size} Bytes)`);

    btnPublish.disabled = false;
  });

  // --- Publish --------------------------------------------------------------
  btnPublish.addEventListener('click', async () => {
    statusEl.textContent = '';

    if (!glbFile) {
      log('⚠ Kein GLB gewählt. Bitte zuerst ein GLB mit Animation auswählen.');
      return;
    }

    const publishKey = keyInput.value.trim();
    if (!publishKey) {
      log('⚠ Bitte den X-AREA-Key aus deinem Cloudflare-Worker eintragen.');
      keyInput.focus();
      return;
    }
    // Nur im Browser merken – niemals im Code
    localStorage.setItem(KEY_STORAGE, publishKey);

    const customId = sceneInput.value.trim();
    const sceneId  = customId || ('light-' + Date.now().toString(36));

    const clipName = (clipInput.value || '').trim() || '*';
    const startMode = startSelect.value || 'onPlace';

    log(`--- Publish startet ---`);
    log(`Scene-ID: ${sceneId}`);
    log(`Clip-Name: ${clipName}`);
    log(`Startmodus: ${startMode}`);

    // scene.json minimal für deinen Surface-Viewer
    const sceneConfig = {
      meta: {
        title: sceneId,
        description: '',
        mode: 'area-viewer'
      },
      model: {
        url: 'scene.glb',
        scale: 1
      },
      animation: {
        clipName: clipName,
        start: startMode,
        loop: true,
        iterations: 9999,
        clampWhenFinished: true
      },
      audio: {
        src: null,
        autoplay: 'withAnimation',
        loop: true,
        volume: 0.85
      },
      ui: {
        showPlayPause: true,
        showMute: false,
        showAR: true,
        arLabel: 'In AR öffnen'
      }
    };

    const fd = new FormData();
    fd.append('sceneId', sceneId);
    fd.append('file', glbFile, 'scene.glb');
    fd.append('file', new Blob(
      [JSON.stringify(sceneConfig, null, 2)],
      { type: 'application/json' }
    ), 'scene.json');

    try {
      log('\nSende Daten an /publish …');
      const res = await fetch(PUBLISH_URL, {
        method: 'POST',
        headers: { 'X-AREA-Key': publishKey },
        body: fd
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(res.status + ' ' + res.statusText + (txt ? ' – ' + txt : ''));
      }

      const data = await res.json().catch(() => ({}));
      log('Publish erfolgreich.');
      log('Antwort vom Worker: ' + JSON.stringify(data, null, 2));

      const returnedId   = data.sceneId || sceneId;
      const viewerUrlRaw = data.viewerUrl || (
        `${VIEWER_BASE}?scene=${encodeURIComponent(returnedId)}&base=${encodeURIComponent(workerOrigin)}`
      );

      log('\nSurface-Viewer-URL:');
      log(viewerUrlRaw);

      // Im neuen Tab öffnen
      window.open(viewerUrlRaw, '_blank');
    } catch (e) {
      console.error(e);
      log('❌ Publish fehlgeschlagen: ' + e.message);
    }
  });
</script>
</body>
</html>
